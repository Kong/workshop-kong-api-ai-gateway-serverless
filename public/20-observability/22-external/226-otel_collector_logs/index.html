<!DOCTYPE html>
<html lang="en-us" dir="ltr" itemscope itemtype="http://schema.org/Article" data-r-output-format="html">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <meta name="generator" content="Hugo 0.148.2">
    <meta name="generator" content="Relearn 8.0.0+9803d5122ebb3276acea823f476e9eb44f607862">
    <meta name="description" content="https://github.com/grafana/loki/blob/main/README.md https://github.com/grafana/loki/blob/main/production/helm/loki/README.md https://grafana.com/docs/loki/next/setup/install/helm/ https://grafana.com/docs/loki/latest/send-data/otel/
We still need to add logs to our environment. To inject Kong Gateway’s Access Logs, we can use Log Processing plugin Kong Gateway provides, for example the TCP Log Plugin.
https://grafana.com/docs/loki/latest/send-data/otel/
https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration
Install Loki First, all the Helm Charts
helm repo add grafana https://grafana.github.io/helm-charts helm repo update kubectl patch svc loki \ -n loki -p ‘{“spec”: {“type”: “LoadBalancer”}}’
Install Loki with the following Helm command. Since we are exposing it with a Load Balancer, Minikube will start a new tunnel for the port 3100.">
    <meta name="author" content="">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="OTel Collector and Logs :: API Management with Kong Konnect">
    <meta name="twitter:description" content="https://github.com/grafana/loki/blob/main/README.md https://github.com/grafana/loki/blob/main/production/helm/loki/README.md https://grafana.com/docs/loki/next/setup/install/helm/ https://grafana.com/docs/loki/latest/send-data/otel/
We still need to add logs to our environment. To inject Kong Gateway’s Access Logs, we can use Log Processing plugin Kong Gateway provides, for example the TCP Log Plugin.
https://grafana.com/docs/loki/latest/send-data/otel/
https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration
Install Loki First, all the Helm Charts
helm repo add grafana https://grafana.github.io/helm-charts helm repo update kubectl patch svc loki \ -n loki -p ‘{“spec”: {“type”: “LoadBalancer”}}’
Install Loki with the following Helm command. Since we are exposing it with a Load Balancer, Minikube will start a new tunnel for the port 3100.">
    <meta property="og:url" content="http://localhost:1313/20-observability/22-external/226-otel_collector_logs/index.html">
    <meta property="og:site_name" content="API Management with Kong Konnect">
    <meta property="og:title" content="OTel Collector and Logs :: API Management with Kong Konnect">
    <meta property="og:description" content="https://github.com/grafana/loki/blob/main/README.md https://github.com/grafana/loki/blob/main/production/helm/loki/README.md https://grafana.com/docs/loki/next/setup/install/helm/ https://grafana.com/docs/loki/latest/send-data/otel/
We still need to add logs to our environment. To inject Kong Gateway’s Access Logs, we can use Log Processing plugin Kong Gateway provides, for example the TCP Log Plugin.
https://grafana.com/docs/loki/latest/send-data/otel/
https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration
Install Loki First, all the Helm Charts
helm repo add grafana https://grafana.github.io/helm-charts helm repo update kubectl patch svc loki \ -n loki -p ‘{“spec”: {“type”: “LoadBalancer”}}’
Install Loki with the following Helm command. Since we are exposing it with a Load Balancer, Minikube will start a new tunnel for the port 3100.">
    <meta property="og:locale" content="en_us">
    <meta property="og:type" content="article">
    <meta property="article:section" content="Observability">
    <meta itemprop="name" content="OTel Collector and Logs :: API Management with Kong Konnect">
    <meta itemprop="description" content="https://github.com/grafana/loki/blob/main/README.md https://github.com/grafana/loki/blob/main/production/helm/loki/README.md https://grafana.com/docs/loki/next/setup/install/helm/ https://grafana.com/docs/loki/latest/send-data/otel/
We still need to add logs to our environment. To inject Kong Gateway’s Access Logs, we can use Log Processing plugin Kong Gateway provides, for example the TCP Log Plugin.
https://grafana.com/docs/loki/latest/send-data/otel/
https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration
Install Loki First, all the Helm Charts
helm repo add grafana https://grafana.github.io/helm-charts helm repo update kubectl patch svc loki \ -n loki -p ‘{“spec”: {“type”: “LoadBalancer”}}’
Install Loki with the following Helm command. Since we are exposing it with a Load Balancer, Minikube will start a new tunnel for the port 3100.">
    <meta itemprop="wordCount" content="1667">
    <title>OTel Collector and Logs :: API Management with Kong Konnect</title>
    <link href="/css/auto-complete/auto-complete.min.css?1755376395" rel="stylesheet">
    <script src="/js/auto-complete/auto-complete.min.js?1755376395" defer></script>
    <script src="/js/search-lunr.js?1755376395" defer></script>
    <script src="/js/search.js?1755376395" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.index_js_url="/searchindex.en.js?1755376395";
    </script>
    <script src="/js/lunr/lunr.min.js?1755376395" defer></script>
    <script src="/js/lunr/lunr.stemmer.support.min.js?1755376395" defer></script>
    <script src="/js/lunr/lunr.multi.min.js?1755376395" defer></script>
    <script src="/js/lunr/lunr.en.min.js?1755376395" defer></script>
    <script>
      window.relearn = window.relearn || {};
      window.relearn.contentLangs=['en'];
    </script>
    <link href="/fonts/fontawesome/css/fontawesome-all.min.css?1755376395" rel="stylesheet" media="print" onload="this.media='all';this.onload=null;"><noscript><link href="/fonts/fontawesome/css/fontawesome-all.min.css?1755376395" rel="stylesheet"></noscript>
    <link href="/css/perfect-scrollbar/perfect-scrollbar.min.css?1755376395" rel="stylesheet">
    <link href="/css/theme.css?1755376395" rel="stylesheet">
    <link href="/css/format-html.css?1755376395" rel="stylesheet" id="R-format-style">
    <script>
      window.relearn = window.relearn || {};
      // configuration
      window.relearn.min = ``;
      window.relearn.path='\/20-observability\/22-external\/226-otel_collector_logs\/index.html';
      window.relearn.relBasePath='..\/..\/..';
      window.relearn.relBaseUri='..\/..\/..';
      window.relearn.absBaseUri='http:\/\/localhost:1313';
      window.relearn.disableAnchorCopy=false;
      window.relearn.disableAnchorScrolling=false;
      window.relearn.disableInlineCopyToClipboard=false;
      window.relearn.enableBlockCodeWrap=true;
      // legal
      window.relearn.getItem = (s,n) => {return s.getItem(n)};
      window.relearn.setItem = (s,n,v) => {return s.setItem(n,v)};
      window.relearn.removeItem = (s,n) => {return s.removeItem(n)};
      // translations
      window.T_Copy_to_clipboard = `Copy to clipboard`;
      window.T_Copied_to_clipboard = `Copied to clipboard!`;
      window.T_Copy_link_to_clipboard = `Copy link to clipboard`;
      window.T_Link_copied_to_clipboard = `Copied link to clipboard!`;
      window.T_Reset_view = `Reset view`;
      window.T_View_reset = `View reset!`;
      window.T_No_results_found = `No results found for "{0}"`;
      window.T_N_results_found = `{1} results found for "{0}"`;
      // variant stuff
      window.relearn.themevariants = [ 'blue' ];
      window.relearn.customvariantname = "my-custom-variant";
      window.relearn.changeVariant = function(variant) {
        var oldVariant = document.documentElement.dataset.rThemeVariant;
        window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        document.documentElement.dataset.rThemeVariant = variant;
        if (oldVariant != variant) {
          document.dispatchEvent( new CustomEvent('themeVariantLoaded', { detail: { variant, oldVariant } }) );
          window.relearn.markVariant();
        }
      }
      window.relearn.markVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant");
        document.querySelectorAll(".R-variantswitcher select").forEach((select) => {select.value = variant;});
      }
      window.relearn.initVariant = function() {
        var variant = window.relearn.getItem(window.localStorage, window.relearn.absBaseUri + "/variant") ?? "";
        if( variant == window.relearn.customvariantname ){
        }else if( !variant || !window.relearn.themevariants.includes(variant) ){
          variant = window.relearn.themevariants[0];
          window.relearn.setItem(window.localStorage, window.relearn.absBaseUri + "/variant", variant);
        }
        document.documentElement.dataset.rThemeVariant = variant;
      }
      window.relearn.initVariant();
      window.relearn.markVariant();
    </script>
  </head>
  <body class="mobile-support html" data-url="/20-observability/22-external/226-otel_collector_logs/index.html">
    <div id="R-body" class="default-animation">
      <div id="R-body-overlay"></div>
      <nav id="R-topbar">
        <div class="topbar-wrapper">
          <div class="topbar-sidebar-divider"></div>
          <div class="topbar-area topbar-area-start" data-area="start">
            <div class="topbar-button topbar-button-sidebar" data-content-empty="disable" data-width-s="show" data-width-m="hide" data-width-l="hide"><button class="topbar-control" onclick="toggleNav()" type="button" title="Menu (CTRL&#43;ALT&#43;n)"><i class="fa-fw fas fa-bars"></i></button>
            </div>
            <div class="topbar-button topbar-button-toc" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="Table of Contents (CTRL&#43;ALT&#43;t)"><i class="fa-fw fas fa-list-alt"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
<nav class="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#install-loki">Install Loki</a></li>
        <li><a href="#new-collector-configuration">New collector configuration</a></li>
        <li><a href="#deploy-the-collector">Deploy the collector</a></li>
        <li><a href="#configure-the-prometheus-and-tcp-log-plugins">Configure the Prometheus and TCP Log Plugins</a></li>
        <li><a href="#update-the-dataplane-with-new-lua-configuration">Update the DataPlane with new Lua configuration</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </div>
              </div>
            </div>
          </div>
          <ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype="http://schema.org/BreadcrumbList"><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/index.html"><span itemprop="name">API Management with Kong Konnect</span></a><meta itemprop="position" content="1">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/20-observability/index.html"><span itemprop="name">Observability</span></a><meta itemprop="position" content="2">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><a itemprop="item" href="/20-observability/22-external/index.html"><span itemprop="name">External Observability Stack</span></a><meta itemprop="position" content="3">&nbsp;>&nbsp;</li><li itemscope itemtype="https://schema.org/ListItem" itemprop="itemListElement" class=""><span itemprop="name">OTel Collector and Logs</span><meta itemprop="position" content="4"></li>
          </ol>
          <div class="topbar-area topbar-area-end" data-area="end">
            <div class="topbar-button topbar-button-prev" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><a class="topbar-control" href="/20-observability/22-external/225-otel_collector_metrics/index.html" title="OTel Collector and Metrics (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a>
            </div>
            <div class="topbar-button topbar-button-next" data-content-empty="disable" data-width-s="show" data-width-m="show" data-width-l="show"><span class="topbar-control"><i class="fa-fw fas fa-chevron-right"></i></span>
            </div>
            <div class="topbar-button topbar-button-more" data-content-empty="hide" data-width-s="show" data-width-m="show" data-width-l="show"><button class="topbar-control" onclick="toggleTopbarFlyout(this)" type="button" title="More"><i class="fa-fw fas fa-ellipsis-v"></i></button>
              <div class="topbar-content">
                <div class="topbar-content-wrapper">
                  <div class="topbar-area topbar-area-more" data-area="more">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div id="R-main-overlay"></div>
      <main id="R-body-inner" class="highlightable 20-observability" tabindex="-1">
        <div class="flex-block-wrapper">
<article class="default">
  <header class="headline">
  </header>

<h1 id="otel-collector-and-logs">OTel Collector and Logs</h1>

<p><a href="https://github.com/grafana/loki/blob/main/README.md" rel="external" target="_blank">https://github.com/grafana/loki/blob/main/README.md</a>
<a href="https://github.com/grafana/loki/blob/main/production/helm/loki/README.md" rel="external" target="_blank">https://github.com/grafana/loki/blob/main/production/helm/loki/README.md</a>
<a href="https://grafana.com/docs/loki/next/setup/install/helm/" rel="external" target="_blank">https://grafana.com/docs/loki/next/setup/install/helm/</a>
<a href="https://grafana.com/docs/loki/latest/send-data/otel/" rel="external" target="_blank">https://grafana.com/docs/loki/latest/send-data/otel/</a></p>
<p>We still need to add logs to our environment. To inject Kong Gateway&rsquo;s Access Logs, we can use Log Processing plugin Kong Gateway provides, for example the <a href="https://docs.konghq.com/hub/kong-inc/tcp-log/" rel="external" target="_blank">TCP Log Plugin</a>.</p>
<p><a href="https://grafana.com/docs/loki/latest/send-data/otel/" rel="external" target="_blank">https://grafana.com/docs/loki/latest/send-data/otel/</a></p>
<p><a href="https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration" rel="external" target="_blank">https://grafana.com/docs/loki/latest/send-data/otel/#loki-configuration</a></p>
<h3 id="install-loki">Install Loki</h3>
<p>First, all the Helm Charts</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>helm repo add grafana https://grafana.github.io/helm-charts
helm repo update</code></pre></div>
<p>kubectl patch svc loki \          <br>
-n loki <br>
-p &lsquo;{&ldquo;spec&rdquo;: {&ldquo;type&rdquo;: &ldquo;LoadBalancer&rdquo;}}&rsquo;</p>
<p>Install Loki with the following Helm command. Since we are exposing it with a Load Balancer, Minikube will start a new tunnel for the port 3100.</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>helm uninstall loki -n loki
kubectl delete namespace loki

helm install loki grafana/loki \
  --namespace=loki --create-namespace \
  -f loki-config.yaml</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>monolith:
  singleBinary:
    replicas: 1
    resources:
      limits:
        cpu: 4000m
        memory: 6Gi  # Large memory for monolith with all components
      requests:
        cpu: 500m
        memory: 1Gi
    persistence:
      enabled: false
    
    extraVolumes:
      - name: tmp-storage
        emptyDir:
          medium: Memory
          sizeLimit: 3Gi  # Large memory allocation for monolith
  
  loki:
    config: |
      # Monolith configuration with all components optimized
      limits_config:
        retention_period: 12h
        max_streams_per_user: 5000
        ingestion_rate_mb: 100  # Very high ingestion for monolith
        per_stream_rate_limit: 20MB
        max_query_parallelism: 32  # Full parallelism utilization

















helm install loki grafana/loki \
  --namespace=loki --create-namespace \
  --set deploymentMode=SingleBinary \
  --set loki.image.tag=&#34;3.5.0&#34; \
  --set singleBinary.replicas=1 \
  --set singleBinary.persistence.enabled=false \
  --set gateway.enabled=false \
  --set monitoring.selfMonitoring.enabled=false \
  --set monitoring.lokiCanary.enabled=false \
  --set test.enabled=false \
  --set write.replicas=0 \
  --set read.replicas=0 \
  --set backend.replicas=0 \
  --set ingester.replicas=0 \
  --set querier.replicas=0 \
  --set queryFrontend.replicas=0 \
  --set queryScheduler.replicas=0 \
  --set distributor.replicas=0 \
  --set compactor.replicas=0 \
  --set indexGateway.replicas=0 \
  --set bloomCompactor.replicas=0 \
  --set bloomGateway.replicas=0 \
  --set ruler.enabled=false \
  --set tableManager.enabled=false

  -f loki-config.yaml






helm install loki grafana/loki \
  --namespace=loki --create-namespace \
  --set replicaCount=1 \
  --set image.tag=3.5.0 \
  --set persistence.enabled=false \
  --set loki.useTestSchema=true \
  --set loki.storage.backend=memory \
  --set loki.storage.bucketNames.chunks=test \
  --set loki.storage.bucketNames.ruler=test \
  --set ruler.enabled=false \
--set backend.replicas=0 \
--set read.replicas=0 \
--set write.replicas=0 \
--set ingester.replicas=0 \
--set querier.replicas=0 \
--set queryFrontend.replicas=0 \
--set queryScheduler.replicas=0 \
--set distributor.replicas=0 \
--set compactor.replicas=0 \
--set indexGateway.replicas=0 \
--set bloomCompactor.replicas=0 \
--set bloomGateway.replicas=0

helm upgrade --install loki grafana/loki \
  --namespace=loki --create-namespace \
  --set loki.image.tag=3.5.0 \
  --set replicaCount=1 \
  --set loki.config.table_manager.retention_deletes_enabled=false \
  --set loki.config.schema_config.configs[0].from=2020-10-15 \
  --set loki.config.schema_config.configs[0].store=memory \
  --set loki.config.schema_config.configs[0].object_store=memory \
  --set loki.config.schema_config.configs[0].schema=v11 \
  --set persistence.enabled=false \
  --set ingress.enabled=false

  config:
    table_manager:
      retention_deletes_enabled: false
    schema_config:
      configs:
        - from: 2020-10-15
          store: memory       # &lt;--- store in memory only
          object_store: memory
          schema: v11
    storage_config:
      memory:
        max_chunks: 100000   # optional, limits memory usage





replicaCount: 1

image:
  tag: &#34;3.5.0&#34;

loki:
  config:
    table_manager:
      retention_deletes_enabled: false
    schema_config:
      configs:
        - from: 2020-10-15
          store: memory       # &lt;--- store in memory only
          object_store: memory
          schema: v11
    storage_config:
      memory:
        max_chunks: 100000   # optional, limits memory usage

persistence:
  enabled: false           # no disk persistence

service:
  type: ClusterIP
  port: 3100

resources:
  requests:
    cpu: 100m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

ingress:
  enabled: false


helm upgrade --install loki grafana/loki \
  --namespace=loki --create-namespace \
  --set singleBinary.enabled=true \
  --set loki.image.tag=3.5.0 \
  --set persistence.enabled=false \
  --set replicas=1 \
  --set test.enabled=false \
  --set loki.useTestSchema=true \
  --set loki.config=&#34;|
    server:
      http_listen_port: 3100
    common:
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
    limits_config:
      allow_structured_metadata: true
    otlp:
      enabled: true
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
&#34; 





helm upgrade --install loki grafana/loki \
  --namespace=loki --create-namespace \
  --version 6.6.3 \
  --set singleBinary.enabled=true \
  --set loki.image.tag=3.5.0 \
  --set persistence.enabled=false \
  --set replicas=1 \
  --set test.enabled=false \
  --set loki.useTestSchema=true \
  --set loki.config=&#34;|
    server:
      http_listen_port: 3100
    common:
      path_prefix: /loki
      storage:
        filesystem:
          chunks_directory: /loki/chunks
          rules_directory: /loki/rules
      replication_factor: 1
    limits_config:
      allow_structured_metadata: true
    otlp:
      enabled: true
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318
&#34; 








helm install loki -n loki grafana/loki-stack \
--create-namespace \
--set loki.image.tag=3.5.3 \
--set loki.service.type=LoadBalancer \
--set promtail.enabled=false \
--set singleBinary.enabled=true \
--set loki.image.tag=3.5.0 \
--set persistence.enabled=false \
--set replicas=1 \
--set read.enabled=false \
--set write.enabled=false \
--set backend.enabled=false \
--set test.enabled=false






helm install loki -n loki grafana/loki-stack \
--create-namespace \
--set loki.image.tag=3.5.3 \
--set loki.service.type=LoadBalancer \
--set promtail.enabled=false \
--set loki.commonConfig.replication_factor=1 \
--set minio.enabled=false


--set config.ChunkStoreConfig.
max_look_back_period not found in type 


--set backend.replicas=0 \
--set read.replicas=0 \
--set write.replicas=0 \
--set ingester.replicas=0 \
--set querier.replicas=0 \
--set queryFrontend.replicas=0 \
--set queryScheduler.replicas=0 \
--set distributor.replicas=0 \
--set compactor.replicas=0 \
--set indexGateway.replicas=0 \
--set bloomCompactor.replicas=0 \
--set bloomGateway.replicas=0

\
queryFrontend:
  replicas: 0
queryScheduler:
  replicas: 0
distributor:
  replicas: 0
compactor:
  replicas: 0
indexGateway:
  replicas: 0
bloomCompactor:
  replicas: 0
bloomGateway:
  replicas: 0
--set deploymentMode=SingleBinary
--set
 \
--set singleBinary.replicas=1

--



helm install loki -n loki grafana/loki-stack \
--create-namespace \
--set loki.image.tag=3.5.3 \
--set loki.service.type=LoadBalancer \
--set promtail.enabled=false
 \

--set loki.service.port=3100 \</code></pre></div>
<p>&ndash;set loki.otlp.http.enabled=true <br>
&ndash;set loki.otlp.http.endpoint=0.0.0.0:4318 \</p>
<p>loki:
server:
http_listen_port: 3100
otlp:
http:
enabled: true
endpoint: 0.0.0.0:4318
grpc:
enabled: true
endpoint: 0.0.0.0:4317</p>
<p>Hit the port to make sure Loki is ready to accept requests:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>curl http://localhost:3100/ready</code></pre></div>
<p>If you want to uninstall it run:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>helm uninstall loki -n loki
kubectl delete namespace loki</code></pre></div>
<h3 id="new-collector-configuration">New collector configuration</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>cat &gt; otelcollector.yaml &lt;&lt; &#39;EOF&#39;
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: collector-kong
  namespace: opentelemetry-operator-system
spec:
  image: otel/opentelemetry-collector-contrib:0.132.2
  serviceAccount: collector
  mode: deployment
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

      prometheus:
        config:
          scrape_configs:
            - job_name: &#39;otel-collector&#39;
              scrape_interval: 5s
              kubernetes_sd_configs:
              - role: pod
              scheme: http
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              authorization:
                credentials_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              metrics_path: /metrics
              relabel_configs:
              - source_labels: [__meta_kubernetes_namespace]
                action: keep
                regex: &#34;kong&#34;
              - source_labels: [__meta_kubernetes_pod_name]
                action: keep
                regex: &#34;dataplane-(.+)&#34;
              - source_labels: [__meta_kubernetes_pod_container_name]
                action: keep
                regex: &#34;proxy&#34;
              - source_labels: [__meta_kubernetes_pod_container_port_number]
                action: keep
                regex: &#34;8100&#34;
      tcplog:
        listen_address: 0.0.0.0:54525
        operators:
          - type: json_parser

    exporters:
      otlphttp/jaeger:
        endpoint: http://jaeger-collector.jaeger:4318
      otlphttp/prometheus:
        endpoint: http://prometheus-operated.prometheus:9090/api/v1/otlp
      otlphttp/loki:
        endpoint: http://loki.loki:3100/otlp
      prometheus:
        endpoint: 0.0.0.0:8889
      #debug:
      #  verbosity: detailed

    processors:
      attributes:
        actions:
          - key: service_name
            action: update
            value: kong-gateway

    service:
      pipelines:
        traces:
          receivers: [otlp]
          exporters: [otlphttp/jaeger]
        metrics:
          receivers: [prometheus]
          exporters: [otlphttp/prometheus, prometheus]
        logs:
          receivers: [tcplog]
          processors: [attributes]
          exporters: [otlphttp/loki]
EOF</code></pre></div>
<p>endpoint: <a href="http://loki.loki:3100/loki/api/v1/push" rel="external" target="_blank">http://loki.loki:3100/loki/api/v1/push</a></p>
<p>The declaration has critical parameters defined:</p>
<ul>
<li>A new TCP Receiver has been added, listening to the port 54525, used by the Kong Gateway TCP Log Plugin. It uses the “json_parser” operator to send formatted data to Dynatrace.</li>
<li>Still inside the “service” section we have included the new “logs” pipeline. Its “receivers” are set to “tcplog” to get data from the TCP Log Kong Gateway Plugin. Its “exporters” is set to a different “otlphttp” which sends data to Loki.</li>
</ul>
<h3 id="deploy-the-collector">Deploy the collector</h3>
<p>Delete the current collector first and instantiate a new one simply submitting the declaration:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>kubectl delete opentelemetrycollector collector-kong -n opentelemetry-operator-system

kubectl apply -f otelcollector.yaml</code></pre></div>
<p>Interestingly enough, the collector service now listens to four ports:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>% kubectl get service collector-kong-collector -n opentelemetry-operator-system 
NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)                                AGE
collector-kong-collector   ClusterIP   10.100.67.18   &lt;none&gt;        4317/TCP,4318/TCP,8889/TCP,54525/TCP   21h</code></pre></div>
<h3 id="configure-the-prometheus-and-tcp-log-plugins">Configure the Prometheus and TCP Log Plugins</h3>
<p>Add the Prometheus and TCP Log plugins to our decK declaration and submit it to Konnect:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>cat &gt; httpbin.yaml &lt;&lt; &#39;EOF&#39;
_format_version: &#34;3.0&#34;
_konnect:
  control_plane_name: kong-workshop
_info:
  select_tags:
  - httpbin-service-route
services:
- name: httpbin-service
  tags:
  - httpbin-service-route
  host: httpbin.kong.svc.cluster.local
  port: 8000
  plugins:
  - name: opentelemetry
    instance_name: opentelemetry1
    enabled: true
    config:
      traces_endpoint: http://collector-kong-collector.opentelemetry-operator-system.svc.cluster.local:4318/v1/traces
      #propagation:
      #  default_format: &#34;w3c&#34;
      #  inject: [&#34;w3c&#34;]
      resource_attributes:
        service.name: &#34;kong-otel&#34;
  - name: prometheus
    instance_name: prometheus1
    enabled: true
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
      upstream_health_metrics: true
      ai_metrics: true
  - name: tcp-log
    instance_name: tcp-log1
    enabled: true
    config:
      host: collector-kong-collector.opentelemetry-operator-system.svc.cluster.local
      port: 54525
      custom_fields_by_lua:
        streams: local ts=string.format(&#39;%18.0f&#39;, os.time()*1000000000) local log_payload         =
          kong.log.serialize() local service = log_payload[&#39;service&#39;] or &#39;noService&#39;
          local cjson         =
          require &#34;cjson&#34; local payload_string = cjson.encode(log_payload) local
          t         = { {stream = {gateway=&#39;kong-gateway&#39;, service_name=service[&#39;name&#39;]},
          values={{ts,         payload_string}}} } return
          t
  routes:
  - name: httpbin-route
    tags:
    - httpbin-service-route
    paths:
    - /httpbin-route
EOF</code></pre></div>
<h3 id="update-the-dataplane-with-new-lua-configuration">Update the DataPlane with new Lua configuration</h3>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>kubectl delete dataplane dataplane1 -n kong</code></pre></div>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: gateway-operator.konghq.com/v1beta1
kind: DataPlane
metadata:
  name: dataplane1
  namespace: kong
spec:
  extensions:
  - kind: KonnectExtension
    name: konnect-config1
    group: konnect.konghq.com
  deployment:
    podTemplateSpec:
      spec:
        containers:
        - name: proxy
          image: kong/kong-gateway:3.11
          env:
          - name: KONG_TRACING_INSTRUMENTATIONS
            value: all
          - name: KONG_TRACING_SAMPLING_RATE
            value: &#34;1.0&#34;
          - name: KONG_UNTRUSTED_LUA_SANDBOX_REQUIRES
            value: cjson
  network:
    services:
      ingress:
        name: proxy1
        type: LoadBalancer
EOF</code></pre></div>
<pre><code>       #value: pl.stringio, ffi-zlib, cjson.safe


    #http://loki.loki:3100g-collector.opentelemetry-operator-system.svc.cluster.local:3500/loki/api/v1/push
</code></pre>
<ul>
<li>name: http-log
instance_name: http-log1
enabled: true
config:
custom_fields_by_lua:
streams: local ts=string.format(&rsquo;%18.0f&rsquo;, os.time()*1000000000) local log_payload         =
kong.log.serialize() local service = log_payload[&lsquo;service&rsquo;] or &rsquo;noService&rsquo;
local cjson         =
require &ldquo;cjson&rdquo; local payload_string = cjson.encode(log_payload) local
t         = { {stream = {gateway=&lsquo;kong-gateway&rsquo;, service=service[&rsquo;name&rsquo;]},
values={{ts,         payload_string}}} } return
t
http_endpoint: <a href="http://collector-kong-collector.opentelemetry-operator-system.svc.cluster.local:3500/loki/api/v1/push" rel="external" target="_blank">http://collector-kong-collector.opentelemetry-operator-system.svc.cluster.local:3500/loki/api/v1/push</a></li>
</ul>
<p>Submit the new plugin declaration with:</p>
<div class="highlight wrap-code" dir="auto"><pre tabindex="0"><code>deck gateway sync --konnect-token $PAT httpbin.yaml</code></pre></div>
<p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/lokiexporter/README.md" rel="external" target="_blank">https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/exporter/lokiexporter/README.md</a>
<a href="https://grafana.com/docs/loki/latest/reference/loki-http-api/#ingest-logs" rel="external" target="_blank">https://grafana.com/docs/loki/latest/reference/loki-http-api/#ingest-logs</a></p>
<p>Consume the Application and check collector&rsquo;s Prometheus endpoint
Using “port-forward”, send a request to the collector&rsquo;s Prometheus endpoint. In a terminal run:</p>
<p>kubectl port-forward service/collector-kong-collector -n opentelemetry-operator-system 8889
Continue navigating the Application to see some metrics getting generated. In another terminal send a request to Prometheus’ endpoint.</p>
<p>% http :8889/metrics
You should see several related Kong metrics including, for example, Histogram metrics like “kong_kong_latency_ms_bucket”, “kong_request_latency_ms_bucket” and “kong_upstream_latency_ms_bucket”. Maybe one of the most important is “kong_http_requests_total” where we can see consumption metrics. Here&rsquo;s a snippet of the output:</p>
<h1 id="help-kong_http_requests_total-http-status-codes-per-consumerserviceroute-in-kong">HELP kong_http_requests_total HTTP status codes per consumer/service/route in Kong</h1>
<h1 id="type-kong_http_requests_total-counter">TYPE kong_http_requests_total counter</h1>
<p>kong_http_requests_total{code=&ldquo;200&rdquo;,instance=&ldquo;192.168.76.233:8100&rdquo;,job=&ldquo;otel-collector&rdquo;,route=&ldquo;coupon_route&rdquo;,service=&ldquo;coupon_service&rdquo;,source=&ldquo;service&rdquo;,workspace=&ldquo;default&rdquo;} 1
kong_http_requests_total{code=&ldquo;200&rdquo;,instance=&ldquo;192.168.76.233:8100&rdquo;,job=&ldquo;otel-collector&rdquo;,route=&ldquo;inventory_route&rdquo;,service=&ldquo;inventory_service&rdquo;,source=&ldquo;service&rdquo;,workspace=&ldquo;default&rdquo;} 1
kong_http_requests_total{code=&ldquo;200&rdquo;,instance=&ldquo;192.168.76.233:8100&rdquo;,job=&ldquo;otel-collector&rdquo;,route=&ldquo;pricing_route&rdquo;,service=&ldquo;pricing_service&rdquo;,source=&ldquo;service&rdquo;,workspace=&ldquo;default&rdquo;} 1
Check Metrics and Logs in Dynatrace
One of the main values provided by Dynatrace is Dashboard creation capabilities. You can create them visually and using DQL (Dynatrace Query Language). As an example, Dynatrace provides a Kong Dashboard where we can manage the main metrics and the access log.</p>
<p>The Kong Dashboard should look like this.</p>
<p>Connecting Log Data to Traces
Dynatrace has the ability to connect Log Events to Traces. That allows us to navigate to the trace associated with a given log event.</p>
<p>In order to do it, the log event has to have a “trace_id” field with the actual trace id it is related to. By default, the OpenTelemetry Plugin injects such a field. However, it adds the format used, in order case “w3c”. For example:</p>
<p>{
&ldquo;trace_id&rdquo;:{
&ldquo;w3c&rdquo;:&ldquo;3b7fb854f5442239c0e94edc69fd6886&rdquo;
},
&ldquo;route&rdquo;:{
&ldquo;paths&rdquo;:[
&ldquo;/coupon&rdquo;
],
&ldquo;created_at&rdquo;:1738765016,
….
}
As you can see here, the TCP Log gets executed after the OpenTelemetry Plugin. So, to solve that, the TCP Log Plugin configuration has the “custom_fields_by_lua” set with a Lua code which removes the “w3c” part out of the field added by the OpenTelemetry Plugin. The new log event can then follow the format Dynatrace looks for:</p>
<p>{
&ldquo;trace_id&rdquo;:&ldquo;3b7fb854f5442239c0e94edc69fd6886&rdquo;,
&ldquo;route&rdquo;:{
&ldquo;paths&rdquo;:[
&ldquo;/inventory&rdquo;
],
&ldquo;created_at&rdquo;:1738765016,
….
}
Here&rsquo;s a Dynatrace Logs app with events generated by the TCP Log Plugin. Choose an event and you&rsquo;ll see the right panel with the “Open trace” button.</p>

  <footer class="footline">
  </footer>
</article>
        </div>
      </main>
    </div>
    <aside id="R-sidebar" class="default-animation">
      <div id="R-header-topbar" class="default-animation"></div>
      <div id="R-header-wrapper" class="default-animation">
        <div id="R-header" class="default-animation">
          <a id="R-logo" class="R-default" href="/index.html">
            <div class="logo-title">API Management with Kong Konnect</div>
          </a>
        </div>
        <search><form action="/search/index.html" method="get">
          <div class="searchbox default-animation">
            <button class="search-detail" type="submit" title="Search (CTRL+ALT+f)"><i class="fas fa-search"></i></button>
            <label class="a11y-only" for="R-search-by">Search</label>
            <input data-search-input id="R-search-by" name="search-by" class="search-by" type="search" placeholder="Search...">
            <button class="search-clear" type="button" data-search-clear="" title="Clear search"><i class="fas fa-times" title="Clear search"></i></button>
          </div>
        </form></search>
      </div>
      <div id="R-homelinks" class="default-animation homelinks">
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-homelinks">
          <ul class="space collapsible-menu">
            <li class="" data-nav-id="/index.html"><a class="padding" href="/index.html"><i class="fa-fw fas fa-home"></i> Home</a></li>
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-headercontrols">
          <ul class="">
          </ul>
        </div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
      </div>
      <div id="R-content-wrapper" class="highlightable">
        <div class="R-sidebarmenu R-shortcutmenu-main">
          <ul class="enlarge morespace collapsible-menu">
            <li class="" data-nav-id="/10-prerequisites/index.html"><a class="padding" href="/10-prerequisites/index.html">Prerequisites</a><ul id="R-subsections-cdc0df3ea972ffd3a9c45dea986dc8ab" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/architecture/index.html"><a class="padding" href="/architecture/index.html">Kong Konnect Architectural Overview</a></li>
            <li class="" data-nav-id="/11-konnect-setup/index.html"><a class="padding" href="/11-konnect-setup/index.html">Konnect Setup</a><ul id="R-subsections-fd457d3a7fac9b2f9cefa5c6c0dae1e7" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/12-api-gateway/index.html"><a class="padding" href="/12-api-gateway/index.html">Kong API Gateway</a><ul id="R-subsections-edeba57bcdf65a92672ecb9c5ed9177f" class="collapsible-menu"></ul></li>
            <li class="" data-nav-id="/16-ai-gateway/index.html"><a class="padding" href="/16-ai-gateway/index.html">Kong AI Gateway</a><ul id="R-subsections-2f2bf218915a29de3a144cfa324a5fc4" class="collapsible-menu"></ul></li>
            <li class="parent " data-nav-id="/20-observability/index.html"><a class="padding" href="/20-observability/index.html">Observability</a><ul id="R-subsections-3829b558aa20efb46efd7e331dc0c9e9" class="collapsible-menu">
            <li class="" data-nav-id="/20-observability/21-builtin/index.html"><a class="padding" href="/20-observability/21-builtin/index.html">Konnect Builtin Observability</a></li>
            <li class="parent alwaysopen " data-nav-id="/20-observability/22-external/index.html"><a class="padding" href="/20-observability/22-external/index.html">External Observability Stack</a><ul id="R-subsections-78b5503c4b9d1c571356633cec18a748" class="collapsible-menu">
            <li class="" data-nav-id="/20-observability/22-external/220-reference_architecture/index.html"><a class="padding" href="/20-observability/22-external/220-reference_architecture/index.html">Reference Architecture</a></li>
            <li class="" data-nav-id="/20-observability/22-external/222-introduction/index.html"><a class="padding" href="/20-observability/22-external/222-introduction/index.html">OpenTelemetry Introduction</a></li>
            <li class="" data-nav-id="/20-observability/22-external/223-otel_collector_installation-copy/index.html"><a class="padding" href="/20-observability/22-external/223-otel_collector_installation-copy/index.html">OTel Collector Installation</a></li>
            <li class="" data-nav-id="/20-observability/22-external/223-otel_collector_installation/index.html"><a class="padding" href="/20-observability/22-external/223-otel_collector_installation/index.html">OTel Collector Installation</a></li>
            <li class="" data-nav-id="/20-observability/22-external/224-otel_collector_tracing/index.html"><a class="padding" href="/20-observability/22-external/224-otel_collector_tracing/index.html">OTel Collector and Tracing</a></li>
            <li class="" data-nav-id="/20-observability/22-external/225-otel_collector_metrics/index.html"><a class="padding" href="/20-observability/22-external/225-otel_collector_metrics/index.html">OTel Collector and Metrics</a></li>
            <li class="active " data-nav-id="/20-observability/22-external/226-otel_collector_logs/index.html"><a class="padding" href="/20-observability/22-external/226-otel_collector_logs/index.html">OTel Collector and Logs</a></li></ul></li></ul></li>
          </ul>
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-shortcuts">
          <ul class="space collapsible-menu">
          </ul>
        </div>
        <div id="R-footer-margin"></div>
        <div class="R-menu-divider default-animation">
          <hr class="padding">
        </div>
        <div class="R-sidebarmenu R-shortcutmenu-footercontrols">
          <ul class="">
          </ul>
        </div>
<div id="R-footer"><p>Built with <a href="https://github.com/McShelby/hugo-theme-relearn" title="love"><i class="fas fa-heart"></i></a> by <a href="https://gohugo.io/">Hugo</a></p></div>
      </div>
    </aside>
    <script src="/js/clipboard/clipboard.min.js?1755376395" defer></script>
    <script src="/js/perfect-scrollbar/perfect-scrollbar.min.js?1755376395" defer></script>
    <script src="/js/theme.js?1755376395" defer></script>
  </body>
</html>
